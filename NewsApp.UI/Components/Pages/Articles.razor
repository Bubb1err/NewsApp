@rendermode InteractiveServer

@inject NavigationManager Navigation
@inject CustomAuthenticationService AuthService

@page "/news"
 
@using NewsApp.Shared.Models.Base
@using NewsApp.Shared.Models.Dto
@using NewsApp.UI.Service
@inject HttpClient Http

<MudContainer MaxWidth="MaxWidth.Large">
    <MudText Typo="Typo.h4" Class="mb-4">Articles</MudText>

    @if (articles == null)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
        <MudText Typo="Typo.body1" Class="mt-3">Loading articles...</MudText>
    }
    else if (!articles.Items.Any())
    {
        <MudText Typo="Typo.body1" Class="mt-3">No articles found.</MudText>
    }
    else
    {
    <MudList T="ArticleDto">
        @foreach (var article in articles.Items)
        {
        <MudListItem T="ArticleDto"  @onclick="() => NavigateToArticleDetail(article.Id)">
            <MudCard Class="mb-3">
                <MudCardContent>
                    <MudText Typo="Typo.h6">@article.Title</MudText>
                    <MudText Typo="Typo.body2">@article.PublishDate.ToShortDateString()</MudText>
                    <MudText Typo="Typo.body1">@article.Content.Substring(0, Math.Min(200, article.Content.Length))...</MudText>
                    
                    <MudIconButton Icon="@Icons.Material.Filled.Favorite" Color="@(IsLiked ? Color.Primary : Color.Dark)"  aria-label="Like" OnClick="ToggleLike"/>
                    <MudIconButton Icon="@Icons.Material.Filled.Bookmark" Color="@(IsSaved ? Color.Primary : Color.Dark)"  aria-label="Like" OnClick="ToggleSave"/>
                </MudCardContent>
            </MudCard>
        </MudListItem>
        }
    </MudList>
    }
</MudContainer>

@code {
    private DataCollectionApiResponseDto<ArticleDto>? articles;
    private bool isAuthenticated= false;
    private bool IsLiked = false;
    
    private bool IsSaved = false;

    
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            isAuthenticated = await AuthService.IsUserAuthenticatedAsync();
            
            try
            {
                articles = await Http.GetFromJsonAsync<DataCollectionApiResponseDto<ArticleDto>>("http://localhost:5296/api/Articles");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error fetching articles: {ex.Message}");
                articles = new DataCollectionApiResponseDto<ArticleDto>();
            }

            StateHasChanged();
        }
    }
    

    private void ToggleLike()
    {
        
        if (isAuthenticated)
        {
            IsLiked = !IsLiked;

        }
        else
        {
            Navigation.NavigateTo($"/auth?returnUrl={Uri.EscapeDataString(Navigation.Uri)}");
        }


    }
    
    private void ToggleSave()
    {
        if (isAuthenticated)
        {
            IsSaved = !IsSaved;

        }
        else
        {
            Navigation.NavigateTo($"/auth?returnUrl={Uri.EscapeDataString(Navigation.Uri)}");
        }

    }
    private void NavigateToArticleDetail(Guid articleId)
    {
        Navigation.NavigateTo($"/article/{articleId}");
    }

}